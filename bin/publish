#!/bin/bash -ex

echo $GITHUB_REPOSITORY
echo $GITHUB_EVENT_NAME
echo $GITHUB_SHA
echo $GITHUB_REF
echo $API_KEY

SHA_VERSION=$(git rev-parse --short $GITHUB_SHA)
SYM_VERSION=$(node -p "require('./package.json').version")

upload_url=$(curl \
    -sSL \
    -XPOST \
    --url https://api.github.com/repos/$GITHUB_REPOSITORY/releases \
    --header "authorization: Bearer $API_KEY" \
    --header "Content-Type:application/json" \
    --data "{
        \"tag_name\": \"v$SYM_VERSION\",
        \"target_commitish\": \"$GITHUB_SHA\",
        \"name\": \"Autorelease for v$SYM_VERSION\",
        \"body\": \"Autorelease for $GITHUB_SHA\",
        \"draft\": false,
        \"prerelease\": false
    }" | \
    jq -r '.upload_url'
)
